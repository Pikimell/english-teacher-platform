{"version":3,"file":"homework.js","sources":["../src/features/homework/homework.js"],"sourcesContent":["import { auth } from '@features/auth/auth.js';\nimport { getUserHomeworkLessons } from '@api/homework.js';\nimport { getUserHomework } from '../../api/homework';\nimport { createPracticeTaskElement } from '@features/practice/practice.js';\nimport { refs } from '@features/layout/dom-refs.js';\n\nconst statusElement = document.querySelector('[data-homework-status]');\nconst listElement = document.querySelector('[data-homework-list]');\n\nif (statusElement && listElement) {\n  let activeRequestId = 0;\n\n  function setStatus(message) {\n    statusElement.textContent = message || '';\n    statusElement.hidden = !message;\n  }\n\n  function clearList() {\n    listElement.innerHTML = '';\n  }\n\n  function resolveLessonUrl(lesson) {\n    if (!lesson || typeof lesson !== 'object') return null;\n    if (typeof lesson.url === 'string' && lesson.url) return lesson.url;\n    if (typeof lesson.link === 'string' && lesson.link) return lesson.link;\n\n    const params = new URLSearchParams();\n    const lessonId = lesson.lessonId || lesson.topicId || lesson.id || null;\n    const htmlPath = lesson.htmlPath || lesson.lessonPath || null;\n    const category = lesson.category || lesson.lessonCategory || null;\n    const level = lesson.level || lesson.lessonLevel || null;\n    const title = lesson.title || lesson.lessonTitle || lesson.name || null;\n\n    if (lessonId) params.set('topic', lessonId);\n    if (category) params.set('category', category);\n    if (level) params.set('level', level);\n    if (title) params.set('title', title);\n    if (htmlPath) params.set('file', htmlPath);\n\n    if (!params.has('topic')) return null;\n    return `lesson.html?${params.toString()}`;\n  }\n\n  function formatDueDate(lesson) {\n    const due =\n      lesson?.dueDate ||\n      lesson?.deadline ||\n      lesson?.due_at ||\n      lesson?.dueAt ||\n      null;\n    if (!due) return null;\n    const date = new Date(due);\n    if (Number.isNaN(date.getTime())) return null;\n    try {\n      return new Intl.DateTimeFormat('uk-UA', {\n        dateStyle: 'medium',\n      }).format(date);\n    } catch (error) {\n      return date.toLocaleDateString('uk-UA');\n    }\n  }\n\n  function createLessonCard(lesson) {\n    const card = document.createElement('article');\n    card.className = 'homework-card';\n    card.setAttribute('role', 'listitem');\n    card.dataset.id = lesson?.lessonId;\n\n    const title = document.createElement('h3');\n    title.className = 'homework-card__title';\n    title.textContent = lesson?.lessonName;\n    card.appendChild(title);\n\n    const dueDateLabel = formatDueDate(lesson);\n    if (dueDateLabel) {\n      const due = document.createElement('p');\n      due.className = 'homework-card__meta';\n      due.textContent = `Строк: ${dueDateLabel}`;\n      card.appendChild(due);\n    }\n\n    const description =\n      lesson?.description || lesson?.lessonDescription || lesson?.summary || '';\n    if (description) {\n      const body = document.createElement('p');\n      body.className = 'homework-card__description';\n      body.textContent = description;\n      card.appendChild(body);\n    }\n\n    const lessonUrl = resolveLessonUrl(lesson);\n    if (lessonUrl) {\n      const link = document.createElement('button');\n      link.className = 'homework-card__link';\n      link.textContent = 'відкрити';\n      card.appendChild(link);\n      card.addEventListener('click', () => {\n        loadHomework(lesson?.lessonId);\n      });\n    }\n\n    return card;\n  }\n\n  function renderLessons(lessons) {\n    console.log(lessons);\n\n    if (!Array.isArray(lessons) || !lessons.length) {\n      setStatus('Домашніх робіт поки немає.');\n      return;\n    }\n\n    setStatus('');\n    const fragment = document.createDocumentFragment();\n    lessons.forEach(lesson => {\n      fragment.appendChild(createLessonCard(lesson));\n    });\n\n    listElement.appendChild(fragment);\n  }\n\n  async function loadLessonsForUser(user) {\n    if (!user || !user.email) {\n      setStatus('Увійдіть, щоб переглянути призначені домашні роботи.');\n      clearList();\n      return;\n    }\n\n    const requestId = ++activeRequestId;\n    setStatus('Завантаження домашніх робіт…');\n    clearList();\n\n    try {\n      const lessons = await getUserHomeworkLessons(user.email);\n      if (requestId !== activeRequestId) return;\n      const list = lessons;\n      console.log(list);\n\n      renderLessons(list);\n    } catch (error) {\n      console.log(error);\n      if (requestId !== activeRequestId) return;\n      console.error('Не вдалося завантажити домашні роботи', error);\n      setStatus('Не вдалося завантажити домашні роботи. Спробуйте пізніше.');\n      clearList();\n    }\n  }\n\n  auth.subscribe(snapshot => {\n    if (!snapshot.isSignedIn) {\n      setStatus('Увійдіть, щоб переглянути призначені домашні роботи.');\n      clearList();\n      return;\n    }\n    loadLessonsForUser(snapshot.user);\n  });\n}\n\nasync function loadHomework(lessonId) {\n  const user = auth.getUser();\n  const userEmail = user.email;\n  const res = await getUserHomework({\n    userEmail,\n    lessonId,\n    limit: 1000,\n  });\n\n  const items = res.items;\n\n  const resContainer = document.createElement('div');\n\n  for (const item of items) {\n    console.log(item);\n\n    if (item.homeworkType === 'task') {\n      try {\n        const data = JSON.parse(item.homeworkData);\n        const node = createPracticeTaskElement(data);\n        resContainer.appendChild(node);\n      } catch {}\n    } else if (item.homeworkType === 'theory') {\n      const data = item.homeworkData;\n      resContainer.insertAdjacentHTML(data);\n    }\n  }\n\n  const container = document.querySelector('.js-homework-content');\n\n  container.innerHTML = resContainer.innerHTML;\n}\n"],"names":["statusElement","listElement","setStatus","message","clearList","resolveLessonUrl","lesson","params","lessonId","htmlPath","category","level","title","formatDueDate","due","date","createLessonCard","card","dueDateLabel","description","body","link","loadHomework","renderLessons","lessons","fragment","activeRequestId","loadLessonsForUser","user","requestId","getUserHomeworkLessons","list","error","auth","snapshot","userEmail","items","getUserHomework","resContainer","item","data","node","createPracticeTaskElement","container"],"mappings":"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"}