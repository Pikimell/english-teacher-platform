{"version":3,"file":"custom-lessons.js","sources":["../src/scripts/custom-lessons.js"],"sourcesContent":["import { lessons } from '../data/lessons.js';\nimport {\n  loadCustomLessons,\n  createCustomLesson,\n  deleteCustomLesson,\n  subscribeToStorage,\n} from './custom-lessons-store.js';\n\nconst form = document.querySelector('[data-builder-form]');\nconst statusElement = document.querySelector('[data-builder-status]');\nconst savedListElement = document.querySelector('[data-saved-list]');\nconst savedEmptyElement = document.querySelector('[data-saved-empty]');\n\nconst groups = Array.from(document.querySelectorAll('[data-builder-group]'));\nlet currentCustomLessons = [];\n\nfunction setCurrentYear() {\n  const yearEl = document.querySelector('[data-component=\"copyright-year\"]');\n  if (yearEl) {\n    yearEl.textContent = String(new Date().getFullYear());\n  }\n}\n\nfunction normalise(value) {\n  return String(value || '')\n    .toLowerCase()\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\nfunction createTopicOption(lesson) {\n  const textContent = `${lesson.title} ${lesson.description || ''} ${(lesson.tags || []).join(' ')}`;\n  const label = document.createElement('label');\n  label.className = 'checkbox builder-option';\n  label.dataset.topicId = lesson.id;\n  label.dataset.searchTokens = normalise(textContent);\n  label.innerHTML = `\n    <input type=\"checkbox\" name=\"topics\" value=\"${lesson.id}\" data-category=\"${lesson.category}\" />\n    <span class=\"builder-option__content\">\n      <span class=\"builder-option__title\">${lesson.title}</span>\n      <span class=\"builder-option__meta\">Рівень: ${lesson.level}${lesson.description ? ` · ${lesson.description}` : ''}</span>\n    </span>\n  `;\n  return label;\n}\n\nfunction populateGroups() {\n  groups.forEach((group) => {\n    const category = group.dataset.builderGroup;\n    const listElement = group.querySelector('[data-group-list]');\n    if (!category || !listElement) return;\n\n    const topics = lessons.filter((lesson) => lesson.category === category);\n    const fragment = document.createDocumentFragment();\n    topics\n      .sort((a, b) => a.title.localeCompare(b.title, 'uk'))\n      .forEach((topic) => fragment.appendChild(createTopicOption(topic)));\n\n    listElement.appendChild(fragment);\n  });\n}\n\nfunction filterGroup(group, query) {\n  const normalizedQuery = normalise(query);\n  const options = Array.from(group.querySelectorAll('.builder-option'));\n  if (!normalizedQuery) {\n    options.forEach((option) => {\n      option.hidden = false;\n    });\n    group.dataset.matches = String(options.length);\n    return;\n  }\n\n  let matches = 0;\n  options.forEach((option) => {\n    const haystack = option.dataset.searchTokens || '';\n    const isMatch = haystack.includes(normalizedQuery);\n    option.hidden = !isMatch;\n    if (isMatch) matches += 1;\n  });\n  group.dataset.matches = String(matches);\n}\n\nfunction handleSearchInput(event) {\n  const input = event.target;\n  const group = input?.closest('[data-builder-group]');\n  if (!group) return;\n  filterGroup(group, input.value);\n}\n\nfunction toggleGroupVisibility(button) {\n  const group = button.closest('[data-builder-group]');\n  if (!group) return;\n  const body = group.querySelector('[data-group-body]');\n  if (!body) return;\n\n  const isHidden = body.hidden;\n  body.hidden = !isHidden;\n  button.textContent = body.hidden ? 'Розгорнути' : 'Згорнути';\n}\n\nfunction collectSelectedTopics() {\n  if (!form) return [];\n  return Array.from(form.querySelectorAll('input[name=\"topics\"]:checked')).map(\n    (input) => ({\n      id: input.value,\n      category: input.dataset.category,\n    }),\n  );\n}\n\nfunction setStatus(message, state = 'idle') {\n  if (!statusElement) return;\n  statusElement.textContent = message;\n  statusElement.dataset.state = state;\n}\n\nfunction createLessonId(title) {\n  const base = normalise(title)\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-+|-+$/g, '')\n    .slice(0, 32);\n  const suffix = Date.now().toString(36);\n  return `custom-${base || 'lesson'}-${suffix}`;\n}\n\nfunction handleFormSubmit(event) {\n  event.preventDefault();\n  setStatus('Зберігаємо…', 'saving');\n\n  const formData = new FormData(form);\n  const title = String(formData.get('title') || '').trim();\n  if (!title) {\n    setStatus('Вкажіть назву уроку.', 'error');\n    return;\n  }\n\n  const selected = collectSelectedTopics();\n  if (!selected.length) {\n    setStatus('Оберіть принаймні одну тему.', 'error');\n    return;\n  }\n\n  const id = createLessonId(title);\n  const topicIds = selected.map((item) => item.id);\n  const lesson = createCustomLesson({ id, title, topicIds });\n  currentCustomLessons = loadCustomLessons();\n  renderSavedLessons();\n  form.reset();\n  groups.forEach((group) => {\n    filterGroup(group, '');\n  });\n  setStatus(`Урок «${lesson.title}» збережено.`, 'success');\n  if (statusElement) {\n    const link = document.createElement('a');\n    link.href = `lesson.html?custom=${encodeURIComponent(lesson.id)}`;\n    link.textContent = ' Відкрити';\n    link.className = 'builder-status__link';\n    statusElement.appendChild(link);\n  }\n}\n\nfunction describeLessonTopics(topicIds) {\n  const topics = topicIds\n    .map((id) => lessons.find((lesson) => lesson.id === id))\n    .filter(Boolean);\n  const grammarCount = topics.filter((topic) => topic.category === 'grammar').length;\n  const communicationCount = topics.filter((topic) => topic.category === 'communication').length;\n  const lexicalCount = topics.filter((topic) => topic.category === 'lexical').length;\n  const titles = topics.map((topic) => topic.title);\n\n  return {\n    grammarCount,\n    communicationCount,\n    lexicalCount,\n    titles,\n  };\n}\n\nfunction renderSavedLessons() {\n  if (!savedListElement || !savedEmptyElement) return;\n\n  const lessonsToRender = currentCustomLessons\n    .slice()\n    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n\n  savedListElement.innerHTML = '';\n\n  if (!lessonsToRender.length) {\n    savedEmptyElement.hidden = false;\n    return;\n  }\n\n  savedEmptyElement.hidden = true;\n\n  const fragment = document.createDocumentFragment();\n  lessonsToRender.forEach((lesson) => {\n    const meta = describeLessonTopics(lesson.topicIds || []);\n    const card = document.createElement('article');\n    card.className = 'builder-card';\n\n    const title = document.createElement('h3');\n    title.className = 'builder-card__title';\n    title.textContent = lesson.title;\n\n    const metaEl = document.createElement('p');\n    metaEl.className = 'builder-card__meta';\n    const metaParts = [];\n    if (meta.grammarCount) metaParts.push(`Граматика: ${meta.grammarCount}`);\n    if (meta.communicationCount) metaParts.push(`Комунікація: ${meta.communicationCount}`);\n    if (meta.lexicalCount) metaParts.push(`Лексика: ${meta.lexicalCount}`);\n    metaEl.textContent = metaParts.join(' · ');\n\n    const topics = document.createElement('p');\n    topics.className = 'builder-card__topics';\n    topics.textContent = meta.titles.join(', ');\n\n    const actions = document.createElement('div');\n    actions.className = 'builder-card__actions';\n\n    const openLink = document.createElement('a');\n    openLink.className = 'button button--ghost';\n    openLink.href = `lesson.html?custom=${encodeURIComponent(lesson.id)}`;\n    openLink.textContent = 'Відкрити';\n\n    const deleteButton = document.createElement('button');\n    deleteButton.className = 'button button--danger';\n    deleteButton.type = 'button';\n    deleteButton.dataset.deleteId = lesson.id;\n    deleteButton.textContent = 'Видалити';\n\n    actions.appendChild(openLink);\n    actions.appendChild(deleteButton);\n\n    card.appendChild(title);\n    if (metaParts.length) {\n      card.appendChild(metaEl);\n    }\n    if (meta.titles.length) {\n      card.appendChild(topics);\n    }\n    card.appendChild(actions);\n    fragment.appendChild(card);\n  });\n\n  savedListElement.appendChild(fragment);\n}\n\nfunction handleSavedListClick(event) {\n  const button = event.target.closest('button[data-delete-id]');\n  if (!button) return;\n  const { deleteId } = button.dataset;\n  if (!deleteId) return;\n  const removed = deleteCustomLesson(deleteId);\n  if (removed) {\n    currentCustomLessons = loadCustomLessons();\n    renderSavedLessons();\n  }\n}\n\nfunction syncWithStorage() {\n  currentCustomLessons = loadCustomLessons();\n  renderSavedLessons();\n}\n\nfunction initControls() {\n  groups.forEach((group) => {\n    const searchInput = group.querySelector('[data-group-search]');\n    const toggleButton = group.querySelector('[data-group-toggle]');\n\n    searchInput?.addEventListener('input', handleSearchInput);\n    toggleButton?.addEventListener('click', (event) => {\n      toggleGroupVisibility(event.currentTarget);\n    });\n  });\n\n  form?.addEventListener('submit', handleFormSubmit);\n  savedListElement?.addEventListener('click', handleSavedListClick);\n\n  subscribeToStorage((lessonsFromStorage) => {\n    currentCustomLessons = lessonsFromStorage;\n    renderSavedLessons();\n  });\n}\n\nfunction init() {\n  setCurrentYear();\n  populateGroups();\n  syncWithStorage();\n  initControls();\n}\n\ninit();\n"],"names":["form","statusElement","savedListElement","savedEmptyElement","groups","currentCustomLessons","setCurrentYear","yearEl","normalise","value","createTopicOption","lesson","textContent","label","populateGroups","group","category","listElement","topics","lessons","fragment","a","b","topic","filterGroup","query","normalizedQuery","options","option","matches","isMatch","handleSearchInput","event","input","toggleGroupVisibility","button","body","isHidden","collectSelectedTopics","setStatus","message","state","createLessonId","title","base","suffix","handleFormSubmit","formData","selected","id","topicIds","item","createCustomLesson","loadCustomLessons","renderSavedLessons","link","describeLessonTopics","grammarCount","communicationCount","lexicalCount","titles","lessonsToRender","meta","card","metaEl","metaParts","actions","openLink","deleteButton","handleSavedListClick","deleteId","deleteCustomLesson","syncWithStorage","initControls","searchInput","toggleButton","subscribeToStorage","lessonsFromStorage","init"],"mappings":"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"}